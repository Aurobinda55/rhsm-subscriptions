#! /usr/bin/env python3

import argparse
import logging
import sys

from rhsm_subscriptions import handlers

logging.basicConfig()
log = logging.getLogger("init-application")

if __name__ == "__main__":
    parser = argparse.ArgumentParser("Init rhsm-subscriptions")
    parser.add_argument("--db-password", help="Database password")
    parser.add_argument("--db-host", default="localhost", help="Database host")
    parser.add_argument("--db-user", default="rhsm-subscriptions", help="Name of the insights DB user")
    parser.add_argument("--db-name", default="rhsm-subscriptions", help="Name of the insights DB")
    parser.add_argument("-v", "--verbose", action="store_true", help="verbose mode")
    parsed_args = parser.parse_args()

    if parsed_args.verbose:
        log.setLevel(logging.DEBUG)
        # Only print stack traces in debug mode
        err_log_func = log.exception
    else:
        log.setLevel(logging.INFO)
        err_log_func = log.error

    rc = 0
    try:
        submodule_handler = handlers.SubmoduleHandler()
        submodule_handler.run()

        db_handler = handlers.PostgresDbHandler(
            db_name=parsed_args.db_name,
            db_host=parsed_args.db_host,
            db_user=parsed_args.db_user,
            db_password=parsed_args.db_password
        )
        db_handler.run()
    except KeyboardInterrupt:
        rc = 1
        log.info("User interrupted execution")
    except RuntimeError as e:
        rc = 1
        err_log_func(str(e))
    except Exception as e:
        log.exception("Unknown error")
    finally:
        sys.exit(rc)

