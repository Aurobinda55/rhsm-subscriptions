# WIP status

* [x] Sample quarkus app running locally
* [x] Connect quarkus app to local db
* [x] Create clowdapp template that includes db
* [x] sample service deploys to EE and connects to ephemeral db
* [x] update service to read from clowder cdconfig file using [clowder-quarkus-config-source](https://github.com/RedHatInsights/clowder-quarkus-config-source)
* [x] update sample service to consume/produce messages onto kafka topic
* [ ] how to view messages on ephemeral environment topics (maybe deploy helper container with kafka cat?)
* [x] introduce kafka as a clowdapp dependency and make it work
* [ ] introduce swatch initdb container so the app connects to the swatch database.  add a resource/service/entity to test
* [ ] set up test profile so unit tests can run with standalone kafka and h2 instances (ie we can unit test without needing database/kafka as a dependency)
* [x] use openapi-generator and openapi spec to generate example rest endpoints
* [ ] figure out how logging works & configure logging config. lombok's @Slf4j wasn't printing to the console, been using system out for now

## build image & push to quay

```bash
QUAY_USER=lburnett
#this is a fake password
QUAY_TOKEN=Passw0rd
IMAGE=quay.io/lburnett/rhsm
IMAGE_TAG=quarkus_poc

docker login -u="$QUAY_USER" -p="$QUAY_TOKEN" quay.io

docker -build --no-cache -t "${IMAGE}:${IMAGE_TAG}" .
docker -push "${IMAGE}:${IMAGE_TAG}"
```

## login to openshift
`oc login --token=Passw0rd --server=https://api.c-rh-c-eph.8p0c.p1.openshiftapps.com:6443`


## setup Virtual Environment
```bash
VENV_DIR=~/bonfire_venv
mkdir -p $VENV_DIR
python3 -m venv $VENV_DIR
. $VENV_DIR/bin/activate
pip install crc-bonfire
pip install --upgrade crc-bonfire
```

## configure ~/.config/bonfire/config.yaml
```yaml
appsFile:
  host: gitlab
  repo: insights-platform/cicd-common
  path: bonfire_configs/ephemeral_apps.yaml

apps:
- name: lburnettquarkus # BONFIRE_APP_NAME
  components:
    - name: service_demo # BONFIRE_COMPONENT_NAME
      host: local
      repo: /home/lburnett/code/rhsm-subscriptions/demo
      path: /deploy/clowdapp.yaml
```

## deploy container with bonfire
```bash
IMAGE=quay.io/lburnett/rhsm
IMAGE_TAG=quarkus_poc
BONFIRE_APP_NAME=lburnettquarkus
BONFIRE_COMPONENT_NAME=service_demo
NAMESPACE=$(bonfire namespace reserve -d 12h)

echo $NAMESPACE

bonfire deploy -n $NAMESPACE \
--no-remove-resources $BONFIRE_COMPONENT_NAME \
-p $BONFIRE_COMPONENT_NAME/IMAGE=$IMAGE \
-i $IMAGE=$IMAGE_TAG $BONFIRE_APP_NAME

```

## port-forward the deployed container
note: i have the namespace hardcoded here...replace with the namespace you reserved
`oc port-forward $(oc -n ephemeral-itjulc get -o name pod | grep fruit) 8000`


## test rest endpoint
note: example uses httpie
```bash
➜ demo (lburnett/sample_service) ✗ http :8000/fruits/apple
HTTP/1.1 200 OK
Content-Type: text/plain;charset=UTF-8
content-length: 11

hello apple

```
